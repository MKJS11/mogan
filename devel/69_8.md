# 69_8: 修复中文中行首和行尾引号的规则

## 2023/12/22

### What

第一次修改：为中文（含繁体中文）新增专用的 `chinese_language_rep` 排版处理逻辑，并将 `"chinese"` 语言切换为使用该实现。

第二次修改：将 `chinese_language_rep` 构造函数中 `do_not_start` 和 `do_not_end` 的初始化方式，从直接添加裸字符串，改为统一使用 `string("...")` 构造，提升类型一致性和代码规范性。

第三次修改：在 Windows 及所有平台下，统一在构建和测试目标中添加 `set_encodings("utf-8")`，强制使用 UTF-8 编码，消除 MSVC 下的 C4819 编码警告，保证跨平台构建时的编码一致性，并简化了构建脚本的相关分支判断。

第四次修改：修正了中文排版规则中对引号（" " ' '）的处理，确保这些符号能正确参与行首/行尾禁则判断，并完善了相关测试用例，提升了中文文本排版的规范性和健壮性。

### Why

第一次修改：原先中文和繁体中文使用通用东方语言（oriental_language_rep）处理，无法满足中文排版的特殊需求。为提升中文排版质量，需引入更符合中文习惯的专用实现。

第二次修改：原有 `do_not_start` 和 `do_not_end` 初始化时混用裸字符串和 `string()`，存在类型不统一和可维护性问题。统一为 `string()` 构造后，代码更规范，类型更安全，便于后续维护。

第三次修改：之前仅在 Windows 下设置 UTF-8 编码，导致构建脚本存在平台分支，且部分情况下仍可能出现编码警告。统一所有平台的编码设置后，构建过程更规范，跨平台兼容性更好，维护也更方便。

第四次修改：之前对中文引号的处理不够完善，可能导致排版时引号出现在不合适的位置（如行首/行尾），不符合中文排版规范。此次修正后，排版效果更符合预期。

### How

第一次修改：
- 新增 `chinese_language_rep` 结构体及其方法，专门处理中文排版规则（如标点禁则等）。
- 修改语言分派逻辑，使 `"chinese"` 使用新的中文排版实现。

第二次修改：
- 将 `do_not_start` 和 `do_not_end` 的所有元素初始化方式统一为 `string("...")`，替换原有裸字符串写法。

第三次修改：
- 在 `xmake.lua` 的目标构建规则中添加 `set_encodings("utf-8")`。
- 在 `xmake/tests.lua` 的测试目标构建规则中添加 `set_encodings("utf-8")`，并删除了原有的 Windows 平台判断分支。

第四次修改：
- 在 `chinese_language_rep` 的 `do_not_start` 和 `do_not_end` 初始化中，修正了引号的处理方式，统一用 `utf8_to_herk` 转换。
- 优化了 `advance` 方法的判断逻辑。
- 在 `TeXmacs/tests/66_13.scm` 中补充了引号相关的 herk/utf8 转换测试用例。

### Result

第一次修改：
- 中文及繁体中文排版效果更符合中文习惯，断行和标点处理更合理。
- 代码结构更清晰，便于后续维护和扩展。

第二次修改：
- 代码风格更统一，类型更安全，后续维护更方便。

第三次修改：
- 所有平台下的源码编译和测试都采用 UTF-8 编码，消除了 MSVC 的编码警告。
- 构建脚本更简洁，维护更方便，跨平台兼容性提升。

第四次修改：
- 中文文本排版时，引号等符号的断行和禁则行为更加规范。
- 相关功能有了更完善的自动化测试保障。

测试文件：TeXmacs/tests/tmu/69_8.tmu

### Links

2023/12/22 第一次修改：https://github.com/XmacsLabs/mogan/pull/1364/files
2023/12/22 第二次修改：https://github.com/XmacsLabs/mogan/pull/1367/files
2023/12/22 第三次修改：https://github.com/XmacsLabs/mogan/pull/1368/files
2024/11/17 第四次修改：https://github.com/XmacsLabs/mogan/pull/2177/files

整理时间：2025/7/7