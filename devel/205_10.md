# 205_10 使用MuPDF库导出PDF

## 2025/08/29 修复OpenType字体嵌入问题
### What
MuPDF在加载OpenType时会[自动提取](https://github.com/ArtifexSoftware/mupdf/blob/1.25.x/source/pdf/pdf-font.c#L568)其中的CFF表，并根据提取后数据调用Freetype解析字体，但是由于纯CFF数据缺乏charmap，导致Freetype无法索引字体内的字形数据。

解决方案是，在加载字体时判断是否为OTF字体，若是则在加载嵌入字体的函数后（pdf_load_font），用正确的字体对象（fz_font）替换掉错误的字体对象。之后便可正确解析字体。

目前嵌入的OTF在子集化过程中（pdf_subset_fonts）会出错，进而造成生成的PDF文件过大。

### Why
在使用Noto Serif CJK系列字体时，MuPDF无法将此类字体顺利嵌入PDF，造成打印的PDF异常

## 2025/08/14 修复MuPDF打印过程中的问题
### What
由于屏幕渲染和打印渲染的差异，将字体加载功能从`mupdf_renderer_rep`中拆分，由子类`mupdf_print_renderer_rep`单独实现。
1. 在`mupdf_print_renderer_rep::get_font_desc`中，字体大小的计算与屏幕渲染时不同
2. 在`load_pdf_font()`中，对于中文TTC字体集合进行拆分，提取出TTF字体

### Why
MuPDF打印的PDF中文字过小，中文字体只有单一样式


## 2025/08/12 初步实现MuPDF打印支持
### What
实现新的渲染器类`mupdf_print_renderer_rep`继承自`mupdf_renderer_rep`，这样可以复用现有MuPDF屏幕渲染器的各种绘图函数。在此基础上，根据打印PDF与屏幕渲染的差异，增加部分自实现函数：
1. begin_page、end_page 用于控制PDF页面的启停
2. flush_metadata 用于向PDF文件中写入元数据

考虑到同时承担屏幕渲染与打印渲染，基类mupdf_renderer_rep作出部分调整以适应：
1. 构造函数新增 screen_flag 标志，并进一步向上级传导，标识当前渲染器对象的功能类型
2. 增加成员变量 doc，在用于屏幕渲染器时，为全局唯一静态变量；在用于打印渲染时，则表示当前正在处理打印的PDF文档

### Why
使用MuPDF库作为PDF导出引擎
