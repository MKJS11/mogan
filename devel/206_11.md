# 修复font-family=ss时emoji字体自动回退的问题

## 2025/08/22

### 如何测试

见206_11.tmu

### What

当设置了`font-family=ss`（无衬线字体族）时，系统会强制使用无衬线字体族，emoji字符也无法使用专门的emoji字体（如Apple Color Emoji、Segoe UI Emoji等），导致显示异常。

### How

在`smart_font.cpp`的`resolve`函数中添加了对emoji字符的特殊处理逻辑：

1. **早期拦截emoji字符**：在函数开始就检测字符的Unicode范围
2. **绕过字体族限制**：emoji字符不受`font-family=ss`等设置限制
3. **直接使用专门字体**：通过`closest_font`直接创建emoji字体

### Why

emoji字符需要使用专门的彩色字体来正确显示，普通的无衬线字体通常不支持emoji。字体族的强制限制会阻止emoji字符使用合适的字体，导致显示问题。

### 核心代码逻辑

```cpp
// 特殊处理emoji字符 - 绕过字体族限制
string range= get_unicode_range (c);
if (range == "emoji") {
  array<string> a= trimmed_tokenize (family, ",");
  for (int i= 0; i < N (a); i++) {
    array<string> parts= trimmed_tokenize (a[i], "=");
    if (N (parts) >= 2 && parts[0] == "emoji") {
      font cfn= closest_font (parts[1], "rm", "medium", "right", sz, dpi, 1);
      if (!is_nil (cfn) && cfn->supports (c)) {
        tree key= tuple ("emoji-font", parts[1]);
        int  nr = sm->add_font (key, REWRITE_NONE);
        initialize_font (nr);
        return sm->add_char (key, c);
      }
    }
  }
}
```