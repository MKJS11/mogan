# 201_15 宏补全
## 如何测试
### 测试实现搜索宏补全项、样式补全项的函数
见自动测试 TeXmacs/tests/201_15.scm 

### 测试宏搜索项的显示
1. 按`\`插入一个宏块
2. 输入任意内容
3. 检查：补全框弹出
4. 按下tab
5. 检查：补全框消失
6. 删除直到宏块被删除
7. 检查：补全框先出现后消失

### 测试宏补全的键盘事件响应
请先阅读 宏补全的键盘事件响应 的 已知问题
1. 按`\`插入一个宏块
2. 自由地输入、删改、点击鼠标、按下tab键
3. 观察响应是否符合预期

### 测试令宏补全项包含键盘命令
1. 插入 `\alp`
2. 检查：补全项，第一项为“alpha”，第二项为“Alpha”

### 测试宏补全排序的次要条件
已在 201_15.scm 中添加自动测试。
1. 插入 `\latex`
2. 检查：补全项，第一项为"latex"，然后才是“LaTeX”, “LaTeX*”, "LaTeXe"等

### 测试宏补全项包括原语
已在 201_15.scm 中添加自动测试。
1. 插入任意原语，例如“string”
2. 检查：补全项的第一项为原语，例如“string”

### 测试获取宏补全项时移除重复项
已在 201_15.scm 中添加自动测试。
1. 插入 `ref`
2. 检查：补全项中不存在重复的`reference`

### 测试解决宏补全下点击选中项无法插入补全的问题
1. 插入 `\st`
2. 使用鼠标点击第一项补全(应当为"stack")
3. 检查：stack 被当作补全正常插入(与回车的表现一致)

## 2025/09/91 在非 Popup 补全模式下令 source_complete_try 快速返回
### What
在非 Popup 补全模式下令 source_complete_try 快速返回，以避免多余的计算。

### Why？
这部分先前疏忽了，应该添加提前 return 的语句的。

## 2025/08/20 解决宏补全下点击选中项无法插入补全的问题
### What
目前在开始宏补全时，如果当前编辑区内容与补全的第一项不同，尝试点击补全的第一项（而不是回车）时不会正常地进行补全插入。

### Why？
在开始宏补全时，补全的第一项即为选中项。点击补全的第一项时，由于选中项与点击项一致，无法触发onCurrentItemChanged事件，从而无法触发 source_complete_variant.

### How?
- 在 QTMCompletionPopup 中添加了成员变量 mode 以区分补全的模式，目前分为 "source" 和 "text"
- 修改了创建 QTMCompletionPopup 时相关的接口，额外传入 mode 的参数
- 在 source 模式下，响应 onItemPressed 事件，尽管这样会造成在(开始宏补全时第一项与编辑区内容不一致)的条件下点击时产生两次source_complete_variant调用，但 source 模式下的 complete_variant 对上一个补全项并不敏感。

## 2025/08/18 获取宏补全项时移除重复项
### What
改用 rich-list 处理宏补全项的获取，并调用了 distinct 实现移除重复项。

## 2025/08/18 令宏补全项包含原语
### What
在 moebius 层添加了获取所有原语的函数 `get_all_primitives`。
在 TeXmacs 的 cpp 层添加了对 moebius 层的调用。
在 Scheme 层添加了glue `tree-primitives`，调用 get_all_primitives

## 2025/08/18 给宏补全排序添加 string<? 的次要条件
### What
目前宏补全排序的条件，为 fuzzy-string-match 返回的分数，在分数一样时，不作顺序改变。这要求输入的链表顺序符合 `string<=?`，才能保证分数相同时短的匹配优先。

现在通过在宏补全的排序条件中添加 `string<?` 的次要条件（当分数一致时用次要条件排序），可以正常处理乱序输入的候选项链表。

已在 201_15.scm 中添加自动测试

### Why
这样做有更好的适用性，避免结果顺序错误

## 2025/08/16 令宏补全项包含键盘命令
### What
令宏补全项包含键盘命令，例如 latex 命令。

### 已知问题
STEM 刚刚启动时补全项可能获取不完整。原因似乎在加载时间上。

### 测试修正获取宏补全项时链表的方向
1. 输入 `\strong`
2. 检查：补全项第一项为`strong`，而非`strong-color`（或者其他更长的项）

## 2025/08/16 修正获取宏补全项时链表的方向
### What
在获取宏补全项时将链表进行了一次 reverse

### Why?
由于链表在 map 过程中会被翻转，需要引入额外的翻转以保证顺序正确

## 2025/08/14 使用模糊匹配筛选宏补全
## 2025/08/15 宏补全的键盘事件响应
### What
宏补全的鼠标键盘事件响应

### How
- 在 source_edit.cpp 中实现了 source_complete_keypress，用于处理宏补全的键盘事件响应
- 在 generic-edit.scm 中添加 kbd-remove 和 keyboard-press 针对宏编辑的重载
- 修改了调用 source_complete_try 的位置，从 handle_keypress 中改到 key_press 的精确位置
- 在 complete_variant 中添加了针对宏补全情况的分支

### 已知问题
鼠标事件的适配未完全完成，点击目前选中的候选项不会插入内容

## 2025/08/14 实现宏搜索项的显示
- 新建了source_edit.cpp，这是因为将来要添加宏补全的键盘响应
- 实现了 source_complete_try 方法，用于显示宏补全
- 在 handle_keypress 结尾添加了是否编辑模式是否为 source 的条件和 source_complete_try 的调用
- 在 complete_variant 添加了检查，避免意外的调用

## 2025/08/14 实现搜索宏补全项、样式补全项的函数
### What
- 实现了 `match-macro-prefix` 函数，其返回所有以 pre 为前缀的宏定义

