# 201_15 宏补全
## 如何测试
### 测试实现搜索宏补全项、样式补全项的函数
见自动测试 TeXmacs/tests/201_15.scm 

### 测试宏搜索项的显示
1. 按`\`插入一个宏块
2. 输入任意内容
3. 检查：补全框弹出
4. 按下tab
5. 检查：补全框消失
6. 删除直到宏块被删除
7. 检查：补全框先出现后消失

### 测试宏补全的键盘事件响应
请先阅读 宏补全的键盘事件响应 的 已知问题
1. 按`\`插入一个宏块
2. 自由地输入、删改、点击鼠标、按下tab键
3. 观察响应是否符合预期

### 测试令宏补全项包含键盘命令
1. 插入 `\alp`
2. 检查：补全项，第一项为“alpha”，第二项为“Alpha”

## 2025/08/16 令宏补全项包含键盘命令
### What
令宏补全项包含键盘命令，例如 latex 命令。

### 已知问题
STEM 刚刚启动时补全项可能获取不完整。原因似乎在加载时间上。

### 测试修正获取宏补全项时链表的方向
1. 输入 `\strong`
2. 检查：补全项第一项为`strong`，而非`strong-color`（或者其他更长的项）

## 2025/08/16 修正获取宏补全项时链表的方向
### What
在获取宏补全项时将链表进行了一次 reverse

### Why?
由于链表在 map 过程中会被翻转，需要引入额外的翻转以保证顺序正确

## 2025/08/14 使用模糊匹配筛选宏补全
## 2025/08/15 宏补全的键盘事件响应
### What
宏补全的鼠标键盘事件响应

### How
- 在 source_edit.cpp 中实现了 source_complete_keypress，用于处理宏补全的键盘事件响应
- 在 generic-edit.scm 中添加 kbd-remove 和 keyboard-press 针对宏编辑的重载
- 修改了调用 source_complete_try 的位置，从 handle_keypress 中改到 key_press 的精确位置
- 在 complete_variant 中添加了针对宏补全情况的分支

### 已知问题
鼠标事件的适配未完全完成，点击目前选中的候选项不会插入内容

## 2025/08/14 实现宏搜索项的显示
- 新建了source_edit.cpp，这是因为将来要添加宏补全的键盘响应
- 实现了 source_complete_try 方法，用于显示宏补全
- 在 handle_keypress 结尾添加了是否编辑模式是否为 source 的条件和 source_complete_try 的调用
- 在 complete_variant 添加了检查，避免意外的调用

## 2025/08/14 实现搜索宏补全项、样式补全项的函数
### What
- 实现了 `match-macro-prefix` 函数，其返回所有以 pre 为前缀的宏定义

