# 207_7 Scheme补全项计算的性能问题 

## 2025/07/28 实现Scheme弹窗补全的分阶段加载与缓存机制

本次优化严格采用哈希表（ahash-table）作为补全缓存底层结构，避免了传统 assoc-set! 基于链表遍历（O(n)）的低效。实际代码中所有缓存操作均为 O(1) 的 ahash-ref、ahash-set!，不存在 assoc-set! 性能瓶颈，适合大规模和高频查询的实际场景。

### What

重构 `scheme-autocomplete.scm`，引入 **分阶段加载（core/full）** + **补全缓存**，并适配 TeXmacs 新旧环境。

### Why

原补全树每次需同步插入全部符号，补全时明显卡顿，体验差。

### How

* 新增全局变量 `core-symbols-loaded?`、`full-load-scheduled?`，通过 `delayed`/`:idle` 定时器实现异步加载和定时初始化。
* `load-core-symbols` 仅同步加载最常用的 glued symbols，并立即可用。
* `load-full-symbols` 异步加载全量 symbol，并通过 `catch` 做异常保护。
* 所有补全结果通过 `completions-cache` 按短前缀缓存，`clear-completions-cache` 保证增量插入/重建后缓存一致性。
* 保持 `scheme-completions-add`/`add-list` 接口兼容，便于后续增量优化。
